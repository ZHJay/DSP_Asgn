<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¢„å¤„ç†åŠŸèƒ½</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app">
        <header class="hero">
            <h1>éŸ³é¢‘å¤„ç†æ§åˆ¶å°</h1>
            <p>æ•°å­—è¯†åˆ«ä¸å£°éŸ³å…‹éš†çš„ç»¼åˆå¹³å°</p>
        </header>

        <nav class="tabs">
            <button 
                class="tab-button" 
                :class="{ active: activeTab === 'recognition' }"
                @click="activeTab = 'recognition'"
            >
                æ•°å­—è¯†åˆ«
            </button>
            <button 
                class="tab-button" 
                :class="{ active: activeTab === 'clone' }"
                @click="activeTab = 'clone'"
            >
                å£°éŸ³å…‹éš†
            </button>
            <button 
                class="tab-button" 
                :class="{ active: activeTab === 'chat' }"
                @click="activeTab = 'chat'"
            >
                æ•°å­—äººå¯¹è¯
            </button>
        </nav>

        <main class="main-grid" v-show="activeTab === 'recognition'">
            <section class="card upload-card">
                <h2>æ–‡ä»¶ä¸Šä¼ </h2>
                <form class="upload-form" enctype="multipart/form-data" @submit.prevent="handleUpload">
                    <label class="file-input">
                        <span>{{ selectedFile ? selectedFile.name : 'é€‰æ‹© WAV æ–‡ä»¶' }}</span>
                        <input type="file" ref="fileInput" accept=".wav" @change="onFileChange" required>
                    </label>
                    <button class="primary-button" type="submit" :disabled="isUploading">
                        {{ isUploading ? 'å¤„ç†ä¸­â€¦' : 'ä¸Šä¼ å¹¶é¢„å¤„ç†' }}
                    </button>
                </form>
            </section>

            <section class="card action-card">
                <h2>åç»­æ“ä½œ</h2>
                <p class="hint" v-if="!lastProcessedFile">é¢„å¤„ç†å®Œæˆåå¯è¿›è¡Œåˆ†æã€‚</p>
                <div class="action-buttons">
                    <button class="action-button" type="button" :disabled="!canProcessTime" @click="processTimeDomain">
                        {{ isProcessing ? 'å¤„ç†ä¸­â€¦' : 'æ—¶åŸŸåˆ†æ' }}
                    </button>
                    <button class="action-button" type="button" :disabled="!canProcessFrequency" @click="processFrequencyDomain">
                        {{ isProcessing ? 'å¤„ç†ä¸­â€¦' : 'é¢‘åŸŸåˆ†æ' }}
                    </button>
                </div>
            </section>

            <section class="card confidence-card">
                <h2>ç½®ä¿¡åº¦å¯è§†åŒ–</h2>

                <div
                    class="chart-board"
                    v-for="section in chartSections"
                    :key="section.key"
                >
                    <div class="chart-board-header">
                        <h3>{{ section.title }}</h3>
                        <span class="chart-status">{{ section.status }}</span>
                    </div>

                    <div class="chart-group" v-if="section.digitBars.length">
                        <h4>æ•°å­—æ¦‚ç‡åˆ†å¸ƒ</h4>
                        <ul class="bar-list">
                            <li class="bar-row" v-for="(item, index) in section.digitBars" :key="`digit-${section.key}-${index}`">
                                <span class="bar-value">{{ item.displayPercent }}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" :style="{ height: item.barHeight }"></div>
                                </div>
                                <span class="bar-label">{{ item.label }}</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else class="chart-placeholder">æš‚æ— æ•°å­—æ•°æ®</p>

                    <div class="chart-group" v-if="section.supportsSpeaker && section.speakerBars.length">
                        <h4>è¯´è¯äººæ¦‚ç‡åˆ†å¸ƒ</h4>
                        <ul class="bar-list">
                            <li class="bar-row" v-for="(item, index) in section.speakerBars" :key="`speaker-${section.key}-${index}`">
                                <span class="bar-value">{{ item.displayPercent }}</span>
                                <div class="bar-track">
                                    <div class="bar-fill bar-fill-alt" :style="{ height: item.barHeight }"></div>
                                </div>
                                <span class="bar-label">{{ item.label }}</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else-if="section.supportsSpeaker" class="chart-placeholder">æš‚æ— è¯´è¯äººæ•°æ®</p>
                </div>
            </section>

            <section class="card feature-card" v-if="timeFeatureGroups.length">
                <div class="feature-header">
                    <div>
                        <h2>æ—¶åŸŸç‰¹å¾æ‘˜è¦</h2>
                        <p class="feature-meta" v-if="timeFeatureMeta">
                            é‡‡æ ·ç‡ï¼š{{ timeFeatureMeta.sampleRate || '--' }} Hz Â·
                            æ—¶é•¿ï¼š{{ formatDuration(timeFeatureMeta.durationSeconds) }} Â·
                            å¸§æ•°ï¼š{{ timeFeatureMeta.frameCount || '--' }}
                        </p>
                    </div>
                    <button class="feature-toggle" type="button" @click="toggleTimeFeatureSection">
                        {{ timeFeatureExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}
                    </button>
                </div>

                <div class="feature-groups" v-show="timeFeatureExpanded">
                    <div class="feature-group" v-for="group in timeFeatureGroups" :key="group.key">
                        <h3>{{ group.title }}</h3>
                        <ul class="feature-metric-list">
                            <li v-for="(metric, index) in group.metrics" :key="`${group.key}-${index}`">
                                <span>{{ metric.label }}</span>
                                <span class="metric-value">{{ formatFeatureMetric(metric.value, metric.unit) }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <section class="card output-card">
                <div class="output-header">
                    <h2>åˆ†ææ—¥å¿—</h2>
                    <div class="output-actions">
                        <button class="link-button" type="button" @click="recognitionLogExpanded = !recognitionLogExpanded">
                            {{ recognitionLogExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}
                        </button>
                        <button class="link-button" type="button" @click="messages = []" :disabled="messages.length === 0">æ¸…ç©º</button>
                    </div>
                </div>
                <div v-show="recognitionLogExpanded">
                    <p v-if="messages.length === 0" class="placeholder">å½“å‰æš‚æ— æ¶ˆæ¯ï¼Œå…ˆä¸Šä¼ éŸ³é¢‘å¼€å§‹æµç¨‹ã€‚</p>
                    <ul v-else class="message-list">
                    <li
                        v-for="(message, index) in messages"
                        :key="index"
                        :class="[
                            'message-item',
                            {
                                'message-success': message.includes('æˆåŠŸ') || message.includes('å®Œæˆ'),
                                'message-error': message.includes('å¤±è´¥') || message.includes('é”™è¯¯')
                            }
                        ]"
                    >
                        <span class="message-index">{{ index + 1 }}</span>
                        <span class="message-text">{{ message }}</span>
                    </li>
                </ul>
                </div>
            </section>
        </main>

        <main class="main-grid clone-grid" v-show="activeTab === 'clone'">
            <section class="card clone-card">
                <h2>å£°éŸ³å…‹éš†</h2>
                <p class="hint">ä¸Šä¼ å‚è€ƒéŸ³é¢‘å¹¶è¾“å…¥æ–‡æœ¬ï¼Œç”Ÿæˆå…‹éš†è¯­éŸ³</p>
                
                <div class="clone-form">
                    <div class="form-group">
                        <label>å‚è€ƒéŸ³é¢‘ï¼š</label>
                        <div class="file-upload-group">
                            <label class="file-input">
                                <span>{{ cloneReferenceFile ? cloneReferenceFile.name : 'é€‰æ‹© WAV æ–‡ä»¶' }}</span>
                                <input type="file" ref="cloneReferenceInput" accept=".wav" @change="onCloneReferenceChange">
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>è¦åˆæˆçš„æ–‡æœ¬ï¼š</label>
                        <textarea 
                            v-model="cloneText" 
                            class="clone-textarea" 
                            placeholder="è¾“å…¥è¦åˆæˆçš„æ–‡æœ¬å†…å®¹..."
                            rows="4"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label>è¯­è¨€ï¼š</label>
                        <select v-model="cloneLanguage" class="clone-select">
                            <option value="zh-cn">ä¸­æ–‡</option>
                            <option value="en">è‹±æ–‡</option>
                        </select>
                    </div>

                    <button 
                        class="primary-button" 
                        @click="handleClone" 
                        :disabled="isCloning || !cloneReferenceFile || !cloneText.trim()"
                    >
                        {{ isCloning ? 'åˆæˆä¸­â€¦' : 'å¼€å§‹åˆæˆ' }}
                    </button>
                </div>

                <div v-if="cloneOutputPath" class="clone-result">
                    <h3>âœ¨ åˆæˆç»“æœ</h3>
                    <audio controls :src="cloneOutputPath" class="clone-audio"></audio>
                    <a :href="cloneOutputPath" download class="download-link">ä¸‹è½½éŸ³é¢‘</a>
                </div>
            </section>

            <section class="card output-card">
                <div class="output-header">
                    <h2>åˆæˆæ—¥å¿—</h2>
                    <div class="output-actions">
                        <button class="link-button" type="button" @click="cloneLogExpanded = !cloneLogExpanded">
                            {{ cloneLogExpanded ? 'æ”¶èµ·' : 'å±•å¼€' }}
                        </button>
                        <button class="link-button" type="button" @click="cloneMessages = []" :disabled="cloneMessages.length === 0">æ¸…ç©º</button>
                    </div>
                </div>
                <div v-show="cloneLogExpanded">
                    <p v-if="cloneMessages.length === 0" class="placeholder">æš‚æ— æ¶ˆæ¯</p>
                    <ul v-else class="message-list">
                        <li
                            v-for="(message, index) in cloneMessages"
                            :key="index"
                            :class="[
                                'message-item',
                                {
                                    'message-success': message.includes('æˆåŠŸ') || message.includes('å®Œæˆ'),
                                    'message-error': message.includes('å¤±è´¥') || message.includes('é”™è¯¯')
                                }
                            ]"
                        >
                            <span class="message-index">{{ index + 1 }}</span>
                            <span class="message-text">{{ message }}</span>
                        </li>
                    </ul>
                </div>
            </section>
        </main>

        <main class="main-grid chat-grid" v-show="activeTab === 'chat'">
            <section class="card chat-settings-card">
                <h2>å¯¹è¯è®¾ç½®</h2>
                <p class="hint">ä¸Šä¼ å‚è€ƒéŸ³è‰²ï¼Œå¼€å¯æ™ºèƒ½å¯¹è¯</p>
                
                <div class="clone-form">
                    <div class="form-group">
                        <label>å‚è€ƒéŸ³è‰²ï¼š</label>
                        <div class="file-upload-group">
                            <label class="file-input">
                                <span>{{ chatReferenceFile ? chatReferenceFile.name : 'é€‰æ‹© WAV æ–‡ä»¶' }}</span>
                                <input type="file" ref="chatReferenceInput" accept=".wav" @change="onChatReferenceChange">
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>å¯¹è¯è¯­è¨€ï¼š</label>
                        <select v-model="chatLanguage" class="clone-select">
                            <option value="zh-cn">ä¸­æ–‡</option>
                            <option value="en">è‹±æ–‡</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ç³»ç»Ÿæç¤ºè¯ï¼š</label>
                        <textarea 
                            v-model="chatSystemPrompt" 
                            class="clone-textarea" 
                            placeholder="è®¾ç½®AIçš„è§’è‰²å’Œè¡Œä¸ºæ–¹å¼..."
                            rows="3"
                        ></textarea>
                    </div>

                    <button 
                        class="primary-button" 
                        @click="resetChat" 
                        :disabled="chatHistory.length === 0"
                    >
                        é‡ç½®å¯¹è¯
                    </button>
                </div>
            </section>

            <section class="card chat-conversation-card">
                <h2>å¯¹è¯çª—å£</h2>
                
                <div class="chat-history" ref="chatHistory">
                    <div v-if="chatHistory.length === 0" class="chat-placeholder">
                        <p>ğŸ‘‹ ä¸Šä¼ å‚è€ƒéŸ³è‰²åï¼Œå¼€å§‹å¯¹è¯å§ï¼</p>
                        <p class="hint">âš ï¸ è¯·ç¡®ä¿æœ¬åœ°LLMæœåŠ¡è¿è¡Œåœ¨ localhost:1234</p>
                    </div>
                    <div v-else class="chat-messages">
                        <div 
                            v-for="(msg, index) in chatHistory" 
                            :key="index"
                            :class="['chat-message', msg.role]"
                        >
                            <div class="message-header">
                                <strong>{{ msg.role === 'user' ? 'ğŸ‘¤ æ‚¨' : 'ğŸ¤– AI' }}</strong>
                                <span class="message-time">{{ msg.time }}</span>
                            </div>
                            <div class="message-content">{{ msg.content }}</div>
                            <audio 
                                v-if="msg.audioPath" 
                                controls 
                                :src="msg.audioPath"
                                class="message-audio"
                            ></audio>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <div class="chat-input-methods">
                        <div class="input-method">
                            <label class="file-input small-file-input">
                                <span>{{ chatAudioFile ? 'âœ“ å·²é€‰æ‹©' : 'ğŸ“ ä¸Šä¼ éŸ³é¢‘' }}</span>
                                <input type="file" ref="chatAudioInput" accept=".wav" @change="onChatAudioChange">
                            </label>
                        </div>
                        <span class="input-separator">æˆ–</span>
                        <div class="input-method">
                            <input 
                                v-model="chatTextInput" 
                                type="text" 
                                class="text-input"
                                placeholder="ç›´æ¥è¾“å…¥æ–‡æœ¬..."
                                @keypress.enter="sendChatMessage"
                            />
                        </div>
                    </div>
                    <button 
                        class="primary-button send-button" 
                        @click="sendChatMessage" 
                        :disabled="isChatting || !chatReferenceFile || (!chatAudioFile && !chatTextInput.trim())"
                    >
                        {{ isChatting ? 'å¤„ç†ä¸­â€¦' : 'å‘é€' }}
                    </button>
                </div>
            </section>
        </main>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="script.js"></script>
</body>
</html>