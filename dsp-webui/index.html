<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>预处理功能</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app">
        <header class="hero">
            <h1>音频处理控制台</h1>
            <p>数字识别与声音克隆的综合平台</p>
        </header>

        <nav class="tabs">
            <button 
                class="tab-button" 
                :class="{ active: activeTab === 'recognition' }"
                @click="activeTab = 'recognition'"
            >
                数字识别
            </button>
            <button 
                class="tab-button" 
                :class="{ active: activeTab === 'clone' }"
                @click="activeTab = 'clone'"
            >
                声音克隆
            </button>
        </nav>

        <main class="main-grid" v-show="activeTab === 'recognition'">
            <section class="card upload-card">
                <h2>文件上传</h2>
                <form class="upload-form" enctype="multipart/form-data" @submit.prevent="handleUpload">
                    <label class="file-input">
                        <span>{{ selectedFile ? selectedFile.name : '选择 WAV 文件' }}</span>
                        <input type="file" ref="fileInput" accept=".wav" @change="onFileChange" required>
                    </label>
                    <button class="primary-button" type="submit" :disabled="isUploading">
                        {{ isUploading ? '处理中…' : '上传并预处理' }}
                    </button>
                </form>
            </section>

            <section class="card action-card">
                <h2>后续操作</h2>
                <p class="hint" v-if="!lastProcessedFile">预处理完成后可进行分析。</p>
                <div class="action-buttons">
                    <button class="action-button" type="button" :disabled="!canProcessTime" @click="processTimeDomain">
                        {{ isProcessing ? '处理中…' : '时域分析' }}
                    </button>
                    <button class="action-button" type="button" :disabled="!canProcessFrequency" @click="processFrequencyDomain">
                        {{ isProcessing ? '处理中…' : '频域分析' }}
                    </button>
                </div>
            </section>

            <section class="card confidence-card">
                <h2>置信度可视化</h2>

                <div
                    class="chart-board"
                    v-for="section in chartSections"
                    :key="section.key"
                >
                    <div class="chart-board-header">
                        <h3>{{ section.title }}</h3>
                        <span class="chart-status">{{ section.status }}</span>
                    </div>

                    <div class="chart-group" v-if="section.digitBars.length">
                        <h4>数字概率分布</h4>
                        <ul class="bar-list">
                            <li class="bar-row" v-for="(item, index) in section.digitBars" :key="`digit-${section.key}-${index}`">
                                <span class="bar-value">{{ item.displayPercent }}</span>
                                <div class="bar-track">
                                    <div class="bar-fill" :style="{ height: item.barHeight }"></div>
                                </div>
                                <span class="bar-label">{{ item.label }}</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else class="chart-placeholder">暂无数字数据</p>

                    <div class="chart-group" v-if="section.supportsSpeaker && section.speakerBars.length">
                        <h4>说话人概率分布</h4>
                        <ul class="bar-list">
                            <li class="bar-row" v-for="(item, index) in section.speakerBars" :key="`speaker-${section.key}-${index}`">
                                <span class="bar-value">{{ item.displayPercent }}</span>
                                <div class="bar-track">
                                    <div class="bar-fill bar-fill-alt" :style="{ height: item.barHeight }"></div>
                                </div>
                                <span class="bar-label">{{ item.label }}</span>
                            </li>
                        </ul>
                    </div>
                    <p v-else-if="section.supportsSpeaker" class="chart-placeholder">暂无说话人数据</p>
                </div>
            </section>

            <section class="card feature-card" v-if="timeFeatureGroups.length">
                <div class="feature-header">
                    <div>
                        <h2>时域特征摘要</h2>
                        <p class="feature-meta" v-if="timeFeatureMeta">
                            采样率：{{ timeFeatureMeta.sampleRate || '--' }} Hz ·
                            时长：{{ formatDuration(timeFeatureMeta.durationSeconds) }} ·
                            帧数：{{ timeFeatureMeta.frameCount || '--' }}
                        </p>
                    </div>
                    <button class="feature-toggle" type="button" @click="toggleTimeFeatureSection">
                        {{ timeFeatureExpanded ? '收起' : '展开' }}
                    </button>
                </div>

                <div class="feature-groups" v-show="timeFeatureExpanded">
                    <div class="feature-group" v-for="group in timeFeatureGroups" :key="group.key">
                        <h3>{{ group.title }}</h3>
                        <ul class="feature-metric-list">
                            <li v-for="(metric, index) in group.metrics" :key="`${group.key}-${index}`">
                                <span>{{ metric.label }}</span>
                                <span class="metric-value">{{ formatFeatureMetric(metric.value, metric.unit) }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </section>

            <section class="card output-card">
                <div class="output-header">
                    <h2>分析日志</h2>
                    <div class="output-actions">
                        <button class="link-button" type="button" @click="recognitionLogExpanded = !recognitionLogExpanded">
                            {{ recognitionLogExpanded ? '收起' : '展开' }}
                        </button>
                        <button class="link-button" type="button" @click="messages = []" :disabled="messages.length === 0">清空</button>
                    </div>
                </div>
                <div v-show="recognitionLogExpanded">
                    <p v-if="messages.length === 0" class="placeholder">当前暂无消息，先上传音频开始流程。</p>
                    <ul v-else class="message-list">
                    <li
                        v-for="(message, index) in messages"
                        :key="index"
                        :class="[
                            'message-item',
                            {
                                'message-success': message.includes('成功') || message.includes('完成'),
                                'message-error': message.includes('失败') || message.includes('错误')
                            }
                        ]"
                    >
                        <span class="message-index">{{ index + 1 }}</span>
                        <span class="message-text">{{ message }}</span>
                    </li>
                </ul>
                </div>
            </section>
        </main>

        <main class="main-grid clone-grid" v-show="activeTab === 'clone'">
            <section class="card clone-card">
                <h2>声音克隆</h2>
                <p class="hint">上传参考音频并输入文本，生成克隆语音</p>
                
                <div class="clone-form">
                    <div class="form-group">
                        <label>参考音频：</label>
                        <div class="file-upload-group">
                            <label class="file-input">
                                <span>{{ cloneReferenceFile ? cloneReferenceFile.name : '选择 WAV 文件' }}</span>
                                <input type="file" ref="cloneReferenceInput" accept=".wav" @change="onCloneReferenceChange">
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>要合成的文本：</label>
                        <textarea 
                            v-model="cloneText" 
                            class="clone-textarea" 
                            placeholder="输入要合成的文本内容..."
                            rows="4"
                        ></textarea>
                    </div>

                    <div class="form-group">
                        <label>语言：</label>
                        <select v-model="cloneLanguage" class="clone-select">
                            <option value="zh-cn">中文</option>
                            <option value="en">英文</option>
                        </select>
                    </div>

                    <button 
                        class="primary-button" 
                        @click="handleClone" 
                        :disabled="isCloning || !cloneReferenceFile || !cloneText.trim()"
                    >
                        {{ isCloning ? '合成中…' : '开始合成' }}
                    </button>
                </div>

                <div v-if="cloneOutputPath" class="clone-result">
                    <h3>✨ 合成结果</h3>
                    <audio controls :src="cloneOutputPath" class="clone-audio"></audio>
                    <a :href="cloneOutputPath" download class="download-link">下载音频</a>
                </div>
            </section>

            <section class="card output-card">
                <div class="output-header">
                    <h2>合成日志</h2>
                    <div class="output-actions">
                        <button class="link-button" type="button" @click="cloneLogExpanded = !cloneLogExpanded">
                            {{ cloneLogExpanded ? '收起' : '展开' }}
                        </button>
                        <button class="link-button" type="button" @click="cloneMessages = []" :disabled="cloneMessages.length === 0">清空</button>
                    </div>
                </div>
                <div v-show="cloneLogExpanded">
                    <p v-if="cloneMessages.length === 0" class="placeholder">暂无消息</p>
                    <ul v-else class="message-list">
                        <li
                            v-for="(message, index) in cloneMessages"
                            :key="index"
                            :class="[
                                'message-item',
                                {
                                    'message-success': message.includes('成功') || message.includes('完成'),
                                    'message-error': message.includes('失败') || message.includes('错误')
                                }
                            ]"
                        >
                            <span class="message-index">{{ index + 1 }}</span>
                            <span class="message-text">{{ message }}</span>
                        </li>
                    </ul>
                </div>
            </section>
        </main>
    </div>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="script.js"></script>
</body>
</html>